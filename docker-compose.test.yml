# Flock — Docker Compose Test Environment
#
# Run all tests:
#   docker compose -f docker-compose.test.yml up --build --abort-on-container-exit
#
# Run specific test:
#   docker compose -f docker-compose.test.yml run --rm test npx vitest run tests/transport/
#
# Interactive shell:
#   docker compose -f docker-compose.test.yml run --rm test bash
#
# Clean up:
#   docker compose -f docker-compose.test.yml down -v

services:
  test:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      # Mount source for live editing (optional — remove for CI)
      # - ./src:/flock/src:ro
      # - ./tests:/flock/tests:ro
      #
      # Temp directory for test artifacts (isolated per run)
      - test-data:/tmp/flock-test
    environment:
      - NODE_ENV=test
      - FLOCK_TEST_DATA=/tmp/flock-test
    tmpfs:
      - /tmp:exec,size=512m

  # Integration test with A2A HTTP server
  integration:
    build:
      context: .
      dockerfile: Dockerfile
    command: ["npx", "vitest", "run", "--project", "integration"]
    volumes:
      - integration-data:/tmp/flock-test
    environment:
      - NODE_ENV=test
      - FLOCK_TEST_DATA=/tmp/flock-test
    tmpfs:
      - /tmp:exec,size=512m

volumes:
  test-data:
  integration-data:
