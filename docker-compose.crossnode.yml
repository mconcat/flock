# Flock â€” Cross-Node Docker Test
#
# Tests A2A communication between two Flock nodes in separate containers.
#
# Run:
#   docker compose -f docker-compose.crossnode.yml up --build --abort-on-container-exit
#
# Clean:
#   docker compose -f docker-compose.crossnode.yml down -v

services:
  node1:
    build:
      context: .
      dockerfile: Dockerfile
    command: ["npx", "tsx", "tests/crossnode/node-runner.ts"]
    environment:
      - FLOCK_NODE_ID=node-1
      - FLOCK_PORT=3001
      - FLOCK_REMOTE_NODES=node-2:http://node2:3002/flock
      - FLOCK_AGENTS=worker-alpha
    networks:
      - flock-net

  node2:
    build:
      context: .
      dockerfile: Dockerfile
    command: ["npx", "tsx", "tests/crossnode/node-runner.ts"]
    environment:
      - FLOCK_NODE_ID=node-2
      - FLOCK_PORT=3002
      - FLOCK_REMOTE_NODES=node-1:http://node1:3001/flock
      - FLOCK_AGENTS=worker-beta
    networks:
      - flock-net

  test:
    build:
      context: .
      dockerfile: Dockerfile
    command: ["npx", "tsx", "tests/crossnode/test-runner.ts"]
    depends_on:
      - node1
      - node2
    environment:
      - NODE1_URL=http://node1:3001/flock
      - NODE2_URL=http://node2:3002/flock
    networks:
      - flock-net

networks:
  flock-net:
